<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta viewport="width=device-width, initial-scale=1.0">
    <title>Lunchtime</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.1.2/dist/tailwind.min.css" rel="stylesheet">
    <meta name="csrf-token" content="{{ csrf_token() }}">
</head>
<body class="bg-yellow-50 font-sans">

    <!-- Top Navigation Bar -->
    <div class="bg-yellow-500 text-white p-4">
        <div class="container mx-auto flex justify-between">
            <a href="/" class="text-lg font-bold">ðŸ¥ªLunchtime</a>
            <div>
                {% if current_user.is_authenticated %}
                <a href="/dashboard" class="px-4 hover:underline">Dashboard</a>
                <a href="/logout" class="px-4 hover:underline">Logout</a>
                {% else %}
                <a href="/signup" class="px-4 hover:underline">Sign Up</a>
                <a href="/login" class="px-4 hover:underline">Login</a>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="flex">
        <!-- Sidebar for Groups, Friends, and Requests -->
        <div class="w-64 bg-white shadow-md">
            {% block sidebar %}{% endblock %}
        </div>

        <!-- Main Content Area -->
        <div class="flex-1 p-10">
            {% block content %}{% endblock %}
        </div>
    </div>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

<script>
    function addFriend(username) {
        $.ajaxSetup({
            beforeSend: function(xhr, settings) {
                if (!/^(GET|HEAD|OPTIONS|TRACE)$/i.test(settings.type) && !this.crossDomain) {
                    xhr.setRequestHeader("X-CSRFToken", $('meta[name="csrf-token"]').attr('content'));
                }
            }
        });
        $.ajax({
            url: '/add-friend',
            type: 'POST',
            data: {username: username},
            success: function(response) {
                alert(response.message);
            },
            error: function(response) {
                alert('Error sending friend request.');
            }
        });
    }

    function fetchDashboardData() {
        $.ajax({
            url: '/fetch-dashboard-data',
            type: 'GET',
            success: function(response) {
                // Update Groups
                var groupsList = $('#groupsList');
                groupsList.empty();
                response.groups.forEach(function(group) {
                    groupsList.append('<li>' + group.name + 
                    '<button onclick="inviteToGroup(\'' + group.id + '\')" class="ml-4 ...">Invite</button></li>');
                });

                // Update Friends List
                var friendsList = $('#friendsList');
                friendsList.empty();
                response.friends.forEach(function(friend) {
                    friendsList.append('<li>' + friend.username + '</li>');
                });

                // Update Pending Requests
                var pendingList = $('#pendingRequestsList');
                pendingList.empty();
                response.pending_requests.forEach(function(request) {
                    var listItem = $('<li class="mb-2 flex justify-between items-center"></li>');
                    listItem.append(request.username);
                    var buttons = $('<div></div>');
                    buttons.append('<button onclick="acceptRequest(\'' + request.id + '\')" class="...">Accept</button>');
                    buttons.append('<button onclick="denyRequest(\'' + request.id + '\')" class="...">Deny</button>');
                    listItem.append(buttons);
                    pendingList.append(listItem);
                });
            },
            error: function() {
                console.log('Error fetching dashboard data.');
            }
        });
    }

    // Initial fetch and set interval for continuous updates
    fetchDashboardData();
    setInterval(fetchDashboardData, 5000); // Adjust interval as needed

    function acceptRequest(requestId) {
        var csrftoken = $('meta[name="csrf-token"]').attr('content');
        $.ajax({
            url: '/accept-request/' + requestId,
            type: 'POST',
            data: {},
            beforeSend: function(xhr) {
                xhr.setRequestHeader("X-CSRFToken", csrftoken);
            },
            success: function(response) {
                alert(response.message);
                location.reload(); // Or update the UI as needed without reloading
            },
            error: function(xhr, status, error) {
                alert('Error accepting request: ' + xhr.responseText);
            }
        });
    }

    function denyRequest(requestId) {
        var csrftoken = $('meta[name="csrf-token"]').attr('content');
        $.ajax({
            url: '/deny-request/' + requestId,
            type: 'POST',
            data: {},
            beforeSend: function(xhr) {
                xhr.setRequestHeader("X-CSRFToken", csrftoken);
            },
            success: function(response) {
                alert(response.message);
                location.reload(); // Reload the page to update the list
            },
            error: function(xhr, status, error) {
                alert('Error accepting request: ' + xhr.responseText);
            }
        });
    }

    function updateFriendRequestButton(username, disabled = true) {
        const button = $(`button[data-username="${username}"]`);
        if (disabled) {
            button.attr('disabled', true);
            button.text('Request Sent');
        } else {
            button.removeAttr('disabled');
            button.text('Add Friend');
        }
    }

    function createGroup(groupName, description) {
        var csrftoken = $('meta[name="csrf-token"]').attr('content');
        $.ajaxSetup({
            beforeSend: function(xhr, settings) {
                if (!/^(GET|HEAD|OPTIONS|TRACE)$/i.test(settings.type) && !this.crossDomain) {
                    xhr.setRequestHeader("X-CSRFToken", csrftoken);
                }
            }
        });
        $.ajax({
            url: '/create-group',
            type: 'POST',
            data: {group_name: groupName, description: description},
            success: function(response) {
                alert(response.message);
                // Optionally refresh part of the page to show the new group
            },
            error: function() {
                alert('Error creating group.');
            }
        });
    }

    function inviteToGroup(groupId) {
        showModal();
        fetchFriendsNotInGroup(groupId);
    }

    function fetchFriendsNotInGroup(groupId) {
        $.ajax({
            url: '/get-friends-not-in-group/' + groupId,
            type: 'GET',
            beforeSend: function(xhr) {
                var csrftoken = $('meta[name="csrf-token"]').attr('content');
                xhr.setRequestHeader("X-CSRFToken", csrftoken);
            },
            success: function(response) {
                var friendListModal = $('#friendListModal');
                friendListModal.empty();
                response.friends.forEach(function(friend) {
                    friendListModal.append('<li>' + friend.username +
                    '<button onclick="addUserToGroup(\'' + friend.id + '\', \'' + groupId + '\')" class="ml-4 bg-blue-500 hover:bg-blue-700 text-white font-bold py-1 px-2 rounded">Invite</button></li>');
                });
            },
            error: function() {
                alert('Error fetching friends.');
            }
        });
    }


    function addUserToGroup(userId, groupId) {
        var csrftoken = $('meta[name="csrf-token"]').attr('content');
        $.ajax({
            url: '/invite-to-group',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ user_id: userId, group_id: groupId }),
            beforeSend: function(xhr) {
                xhr.setRequestHeader("X-CSRFToken", csrftoken);
            },
            success: function(response) {
                alert(response.message);
                closeModal(); // Close the modal
                location.reload(); // Optionally, reload to update the UI
            },
            error: function(xhr) {
                alert('Error adding user to group: ' + xhr.responseText);
            }
        });
    }




</script>
</body>
</html>
